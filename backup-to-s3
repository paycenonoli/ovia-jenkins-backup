pipeline {
  agent any
  stages {
    stage('Jenkins Backup') {
      steps {
        sh '''
          # Create a tar backup of the Jenkins directory
          tar -czf /tmp/jenkinsBackup.tar.gz -C /var/lib jenkins
        '''
      }
    }

    stage('Upload to S3 Bucket') {
      steps {
        script {
          // Move the tar file to the workspace
          sh 'mv /tmp/jenkinsBackup.tar.gz ${WORKSPACE}/jenkinsBackup.tar.gz'

          // Upload the tar file from the workspace
          s3Upload consoleLogLevel: 'INFO', dontSetBuildResultOnFailure: false, dontWaitForConcurrentBuildCompletion: false, entries: [
            [bucket: 'ovia-jenkins-backup', excludedFile: '', flatten: false, gzipFiles: false, keepForever: false, managedArtifacts: false, noUploadOnFailure: false,
            selectedRegion: 'us-east-2', showDirectlyInBrowser: false, sourceFile: '${WORKSPACE}/jenkinsBackup.tar.gz', storageClass: 'STANDARD', uploadFromSlave: false,
            useServerSideEncryption: false]
          ], pluginFailureResultConstraint: 'FAILURE', profileName: 'ovia-jenkins-backup', userMetadata: []
        }
      }
    }
  }
}
